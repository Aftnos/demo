# 设计表拖动功能说明

## 一、整体架构

表单设计器的字段拖放系统，采用 Vue 3 + TypeScript 实现，使用原生 HTML5 Drag and Drop API。

### 主要组件

| 组件         | 路径                          | 职责                      |
| ------------ | ----------------------------- | ------------------------- |
| FieldToolbox | `components/FieldToolbox.vue` | 左侧字段工具箱（拖动源）  |
| FormCanvas   | `components/FormCanvas.vue`   | 中间画布（放置区域）      |
| FieldItem    | `components/FieldItem.vue`    | 字段项（可拖动 + 可放置） |
| useDragDrop  | `composables/useDragDrop.ts`  | 拖放逻辑 composable       |

## 二、拖动来源

1. **工具箱拖入**：从左侧工具箱拖拽字段类型到画布，创建新字段
2. **画布内移动**：拖动已有字段调整顺序或移入/移出容器

## 三、拖放位置计算规则

### 普通字段

- 鼠标在目标字段**上半部分** → 插入到目标上方（before）
- 鼠标在目标字段**下半部分** → 插入到目标下方（after）
- 只有每层第一个字段（order === 0）才显示 before 指示线

### 容器类字段

容器类型包括：`group-header`、`container`、`payment`、`receipt`

- 上 1/4 区域 → before（插入到容器上方）
- 下 1/4 区域 → after（插入到容器下方）
- 中间 1/2 区域 → inside（放入容器内部）

## 四、视觉反馈

### 拖动中的字段

```scss
&.dragging {
  opacity: 0.5;
  transform: scale(0.98);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
```

### 放置指示线

| 位置   | 颜色            | 含义       |
| ------ | --------------- | ---------- |
| before | 绿色 + 脉冲动画 | 插入到上方 |
| after  | 蓝色 + 脉冲动画 | 插入到下方 |

### 文字提示

字段右侧显示位置提示：

- `↑ 上方`（绿色背景）
- `↓ 下方`（蓝色背景）

### 容器高亮

放入容器时：

- 容器背景变为 `--el-color-primary-light-9`
- 显示 2px 虚线边框

### 空画布提示

拖入空画布时居中显示「拖拽字段到这里」提示框

## 五、拖放数据传递

使用 `dataTransfer.setData('application/json', ...)` 传递 JSON 数据：

```typescript
interface DragData {
  source: 'toolbox' | 'moveField' // 来源类型
  fieldType: string // 字段类型
  config: FieldDefinition // 字段配置
}
```

### 工具箱拖出

```typescript
event.dataTransfer.setData(
  'application/json',
  JSON.stringify({
    source: 'toolbox',
    fieldType: config.type,
    config: config.defaultConfig
  })
)
```

### 画布内移动

```typescript
event.dataTransfer.setData(
  'application/json',
  JSON.stringify({
    source: 'moveField',
    fieldType: config.type,
    config: { ...config, defaultConfig: config }
  })
)
```

## 六、无效拖放检测

以下情况不显示放置指示线：

1. **拖到自己身上** - `draggedId === targetId`
2. **拖到自己的子孙节点** - 通过 `checkIsDescendant()` 递归检查
3. **移动后位置不变** - 如第一个字段拖到 before 位置

```typescript
const isInvalidMove = (position: 'before' | 'after'): boolean => {
  // 同一父级下，第一个字段拖到 before 位置无效
  if (position === 'before' && draggedField.order === 0) return true
  // 同一父级下，拖到紧邻下方字段的 after 位置无效
  if (position === 'after' && draggedField.order === currentField.order + 1) return true
  return false
}
```

## 七、全局状态管理

通过 `provide/inject` 共享全局拖拽状态，确保同一时刻只有一个字段显示放置指示线：

```typescript
const globalDragState = {
  draggedFieldId: ref<string | null>(null), // 正在拖动的字段 ID
  activeDropTargetId: ref<string | null>(null) // 当前激活的放置目标 ID
}

// 在 FormCanvas 中 provide
provide('globalDragState', globalDragState)

// 在 FieldItem 中 inject
const globalDragState = inject('globalDragState')
```

### 状态同步

当 `activeDropTargetId` 变化时，非活动字段自动清除指示线：

```typescript
watch(
  () => globalDragState.activeDropTargetId.value,
  (newTargetId) => {
    if (newTargetId !== props.config.id && dropPosition.value !== 'none') {
      dropPosition.value = 'none'
    }
  }
)
```

## 八、拖动触发方式

必须通过拖动手柄（Rank 图标）触发拖动：

```typescript
// mousedown 时启用拖动
const handleMouseDown = () => {
  isDragging.value = true
}

// mouseup 时禁用拖动
const handleMouseUp = () => {
  isDragging.value = false
}
```

```vue
<div class="field-item" :draggable="isDragging">
  <el-icon class="drag-handle" @mousedown="handleMouseDown" @mouseup="handleMouseUp">
    <Rank />
  </el-icon>
</div>
```

## 九、插入位置计算

### 放置到字段上

```typescript
const handleFieldDrop = (event: DragEvent) => {
  const targetOrder = props.config.order
  const insertIndex = dropPosition.value === 'before' ? targetOrder : targetOrder + 1
  const insertParentId = props.config.parentId || undefined

  if (source === 'toolbox') {
    formDesignerStore.addField(config, insertIndex, insertParentId)
  } else if (source === 'moveField') {
    formDesignerStore.moveField(config.id, insertIndex, insertParentId, config.parentId)
  }
}
```

### 放置到容器内

```typescript
const handleContainerDrop = (event: DragEvent) => {
  const insertParentId = props.config.id // 容器自身 ID
  const insertIndex = allFields.filter((f) => f.parentId === insertParentId).length // 末尾

  if (source === 'toolbox') {
    formDesignerStore.addField(config, insertIndex, insertParentId)
  } else if (source === 'moveField') {
    formDesignerStore.moveField(config.id, insertIndex, insertParentId, config.parentId)
  }
}
```

## 十、关键 DOM 属性

FieldItem 通过 `data-*` 属性传递位置信息：

```vue
<div class="field-box"
  :data-order="config.order"
  :data-parent-id="getParentIdForChildren"
  :data-real-parent-id="getRealParentId"
  :data-type="config.type"
  :data-id="config.id"
  :data-drop-position="dropPosition"
>
```

| 属性                | 含义                              |
| ------------------- | --------------------------------- |
| data-order          | 字段在同级中的顺序                |
| data-parent-id      | 用于子字段拖入时的父级 ID         |
| data-real-parent-id | 字段自身的真实父级 ID             |
| data-type           | 字段类型                          |
| data-id             | 字段 ID                           |
| data-drop-position  | 当前放置位置（before/after/none） |
